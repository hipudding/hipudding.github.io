<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="https://dogecoin.com/assets/images/doge.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="https://dogecoin.com/assets/images/doge.svg">
  <link rel="icon" type="image/png" sizes="16x16" href="https://dogecoin.com/assets/images/doge.svg">
  <link rel="mask-icon" href="https://dogecoin.com/assets/images/doge.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.22.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>



<link rel="canonical" href="http://example.com/2025/01/23/Ray%E6%8A%80%E6%9C%AF%E5%85%A5%E9%97%A8-%E7%BC%96%E8%AF%91%E9%83%A8%E7%BD%B2%E5%92%8C%E4%BB%BB%E5%8A%A1%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2025/01/23/Ray%E6%8A%80%E6%9C%AF%E5%85%A5%E9%97%A8-%E7%BC%96%E8%AF%91%E9%83%A8%E7%BD%B2%E5%92%8C%E4%BB%BB%E5%8A%A1%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/","path":"2025/01/23/Ray技术入门-编译部署和任务生命周期/","title":"Ray技术入门-编译部署和任务生命周期"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Ray技术入门-编译部署和任务生命周期 | hipudding's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">hipudding's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86"><span class="nav-number">1.</span> <span class="nav-text">背景知识</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#bazel"><span class="nav-number">1.1.</span> <span class="nav-text">Bazel</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#grpc"><span class="nav-number">1.2.</span> <span class="nav-text">gRPC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cython"><span class="nav-number">1.3.</span> <span class="nav-text">cython</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%92%E8%89%B2"><span class="nav-number">2.</span> <span class="nav-text">角色</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#node"><span class="nav-number">2.1.</span> <span class="nav-text">Node</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gcs_server"><span class="nav-number">2.2.</span> <span class="nav-text">gcs_server</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#raylet"><span class="nav-number">2.3.</span> <span class="nav-text">raylet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#worker"><span class="nav-number">2.4.</span> <span class="nav-text">worker</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#actor"><span class="nav-number">2.5.</span> <span class="nav-text">actor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#driver"><span class="nav-number">2.6.</span> <span class="nav-text">driver</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91"><span class="nav-number">3.</span> <span class="nav-text">编译</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8conda%E7%8E%AF%E5%A2%83"><span class="nav-number">3.1.</span> <span class="nav-text">使用Conda环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96"><span class="nav-number">3.2.</span> <span class="nav-text">安装依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA"><span class="nav-number">3.3.</span> <span class="nav-text">构建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%AF%E9%80%89%E7%9A%84%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="nav-number">3.4.</span> <span class="nav-text">可选的编译环境变量</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E4%B8%80%E4%B8%AAray%E9%9B%86%E7%BE%A4"><span class="nav-number">4.</span> <span class="nav-text">启动一个Ray集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%B4%E6%97%B6%E5%90%AF%E5%8A%A8"><span class="nav-number">4.1.</span> <span class="nav-text">临时启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E9%9B%86%E7%BE%A4"><span class="nav-number">4.2.</span> <span class="nav-text">启动集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E7%94%A8%E7%9B%91%E6%8E%A7"><span class="nav-number">4.3.</span> <span class="nav-text">启用监控</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8F%90%E4%BA%A4%E4%B8%80%E4%B8%AA%E4%BB%BB%E5%8A%A1"><span class="nav-number">4.4.</span> <span class="nav-text">提交一个任务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E4%B8%80%E4%B8%AA%E6%9C%8D%E5%8A%A1"><span class="nav-number">4.5.</span> <span class="nav-text">部署一个服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B0%83%E8%AF%95"><span class="nav-number">5.</span> <span class="nav-text">调试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E8%AF%95python"><span class="nav-number">5.1.</span> <span class="nav-text">调试python</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E8%AF%95driver"><span class="nav-number">5.2.</span> <span class="nav-text">调试Driver</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E8%AF%95worker%E6%88%96%E8%80%85%E5%85%B6%E4%BB%96%E8%BF%9B%E7%A8%8B"><span class="nav-number">5.3.</span> <span class="nav-text">调试Worker或者其他进程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#grpc%E6%B5%81%E7%A8%8B"><span class="nav-number">6.</span> <span class="nav-text">gRPC流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#grpc%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">6.1.</span> <span class="nav-text">gRPC是什么</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#grpc-client"><span class="nav-number">6.2.</span> <span class="nav-text">gRPC client</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#grpc-server"><span class="nav-number">6.3.</span> <span class="nav-text">gRPC server</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%AC%E5%9C%B0%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8"><span class="nav-number">6.4.</span> <span class="nav-text">本地异步调用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#driver%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B"><span class="nav-number">7.</span> <span class="nav-text">Driver提交流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#python%E9%83%A8%E5%88%86"><span class="nav-number">7.1.</span> <span class="nav-text">Python部分</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#driver%E9%83%A8%E5%88%86"><span class="nav-number">7.2.</span> <span class="nav-text">Driver部分</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#worker%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-number">8.</span> <span class="nav-text">Worker执行流程</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="hipudding"
      src="https://dogecoin.com/assets/images/doge.svg">
  <p class="site-author-name" itemprop="name">hipudding</p>
  <div class="site-description" itemprop="description"></div>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/hipudding" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hipudding" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:huafengchun@gmail.com" title="E-Mail → mailto:huafengchun@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/01/23/Ray%E6%8A%80%E6%9C%AF%E5%85%A5%E9%97%A8-%E7%BC%96%E8%AF%91%E9%83%A8%E7%BD%B2%E5%92%8C%E4%BB%BB%E5%8A%A1%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://dogecoin.com/assets/images/doge.svg">
      <meta itemprop="name" content="hipudding">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hipudding's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Ray技术入门-编译部署和任务生命周期 | hipudding's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Ray技术入门-编译部署和任务生命周期
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-01-23 11:39:15" itemprop="dateCreated datePublished" datetime="2025-01-23T11:39:15+08:00">2025-01-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-18 15:32:34" itemprop="dateModified" datetime="2025-02-18T15:32:34+08:00">2025-02-18</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="背景知识">背景知识</h2>
<p>Ray是一个使用Bazel构建的，基于gRPC上层打造的开源分布式计算框架，旨在简化分布式应用的开发和运行。它支持无缝地将
Python 代码扩展到多核、多节点环境，适合构建高性能的分布式系统。Ray
提供灵活的任务调度和状态管理，支持多种编程模型，包括任务并行和 actor
模式，并通过自动化的资源管理和容错机制简化复杂分布式工作的部署。它还拥有丰富的生态系统，包含机器学习库（如
Ray Tune、Ray Serve 和
RLlib），适用于模型训练、超参数调优、在线服务等场景，是云原生应用和大规模计算的理想选择。</p>
<p><strong><a
target="_blank" rel="noopener" href="https://github.com/ray-project/ray">社区</a></strong>，<strong><a
target="_blank" rel="noopener" href="https://www.ray.io/">主页</a></strong></p>
<h3 id="bazel">Bazel</h3>
<p>Bazel是一种高效、可扩展的构建工具，最初由Google开发，专为管理大型代码库和复杂项目而设计。它支持多语言和多平台构建，包括C++,
Java, Python,
Go等，并能够跨操作系统（如Linux、macOS和Windows）执行构建任务。Bazel通过声明式的构建规则（BUILD文件）和依赖管理，实现了高性能的增量构建，避免了不必要的重复编译。其特点包括分布式构建、沙盒化执行和强大的缓存机制，可以加快构建速度并提高构建的稳定性。此外，Bazel还提供高度可配置的扩展机制，方便开发者为特定需求编写自定义规则，适合从小型项目到超大规模工程的使用场景。</p>
<p><strong><a
target="_blank" rel="noopener" href="https://github.com/bazelbuild/bazel">社区</a></strong>，<strong><a
target="_blank" rel="noopener" href="https://bazel.build">主页</a></strong></p>
<h3 id="grpc">gRPC</h3>
<p>gRPC 是由 Google 开发的高性能开源 RPC 框架，基于 HTTP/2
协议，支持多语言和跨平台通信。它使用 Protocol Buffers
定义接口和序列化数据，简化了服务间的集成开发。gRPC
提供高效的请求-响应模型、流式传输、负载均衡和内置 TLS
安全特性，非常适合云原生应用、微服务架构和实时通信场景，广泛应用于分布式系统和高性能应用开发中。</p>
<p><strong><a
target="_blank" rel="noopener" href="https://github.com/grpc/grpc">社区</a></strong>，<strong><a
target="_blank" rel="noopener" href="https://grpc.io/">主页</a></strong></p>
<h3 id="cython">cython</h3>
<p>Cython 是一种优化的 Python 扩展语言，结合了 Python 的易用性和 C
的高性能，旨在提升 Python 代码的运行速度。通过将 Python 代码转译为 C 或
C++ 并进行编译，Cython 可以显著减少运行时的性能开销，同时支持调用 C/C++
库，从而实现与底层代码的高效交互。Cython 保留了大部分 Python
的语法，同时允许使用 C
类型声明进行性能优化，非常适合计算密集型任务或对性能要求较高的场景，如科学计算、机器学习和数据处理。</p>
<p><strong><a
target="_blank" rel="noopener" href="https://github.com/cython/cython">社区</a></strong>，<strong><a
target="_blank" rel="noopener" href="https://cython.org/">主页</a></strong></p>
<h2 id="角色">角色</h2>
<p>Ray集群的整体架构如下图所示</p>
<figure>
<img
src="https://raw.githubusercontent.com/hipudding/blog_img/main/img/06_Ray架构图-20250121160411114.png"
alt="Ray架构图" />
<figcaption aria-hidden="true">Ray架构图</figcaption>
</figure>
<p>一个Ray集群包括多个Node节点，其中每个Node节点包含Actor，Worker，共享内存，本地调度器。其中Head
Node还有GCS服务，包含各类元数据存储，WebUI，全局调度等功能。</p>
<h3 id="node">Node</h3>
<figure>
<img
src="https://raw.githubusercontent.com/hipudding/blog_img/main/img/v2-cf09ec3ccc183b816fa303164f4144b3_1440w.jpg"
alt="Ray Nodes" />
<figcaption aria-hidden="true">Ray Nodes</figcaption>
</figure>
<p>Node中包含一个Raylet进程，负责本地调度以及共享内存。Raylet会根据任务情况启动一个或者多个worker或者Actor。Head
node是一个特殊的Node，除了普通Node的功能之外，还有一些外的进程，包括gcs_server服务，dashboard等。并且每个Node节点还会启动monitor进程，log_monitor进程，agent进程等。</p>
<p>Raylet和gcs_server是非Python进程，其他辅助进程，包括Driver，worker以及Actor均是python进程（针对Python语言而言）。</p>
<h3 id="gcs_server">gcs_server</h3>
<p>Ray 的 GCS Server 是 Ray
框架的核心组件，负责元数据存储、任务调度、资源管理和集群状态维护。它通过存储模块（Redis
或 内存）管理节点和任务的生命周期，使用 Pub-Sub
系统进行状态广播，并通过高效的调度协调与其他组件（如 Scheduler, Worker,
Actor 或
Object）协作，确保系统的高性能、高可用性和灵活扩展性。gcs_server是一个非Python进程，二进制文件路径在
<code>ray/python/ray/core/src/ray/gcs/gcs_server</code>。</p>
<h3 id="raylet">raylet</h3>
<p>Raylet 是 Ray
集群中每个节点的核心运行时组件，负责任务执行、资源管理和数据依赖协调。它接收
GCS Server 分配的任务，管理本地资源，启动 Worker 进程执行任务，并通过
Plasma Store 处理数据存储与传输。同时，Raylet 定期向 GCS Server
汇报节点状态，协作实现任务调度、资源分配和故障恢复，是 Ray
分布式运行的关键执行单元。raylet是一个非Python进程，二进制文件路径在
<code>ray/python/ray/core/src/ray/raylet/raylet</code>。</p>
<h3 id="worker">worker</h3>
<p>Worker 是 Ray 中的核心计算单元，由 Raylet 启动，负责具体任务的执行和
Actor 的运行。它与 Plasma Store 协作进行数据存取，并通过与 Raylet
的通信完成任务调度和资源管理。Worker 支持多语言运行环境（如
Python、Java），能够高效并行处理任务，是 Ray
框架实现分布式计算的基础组件。</p>
<h3 id="actor">actor</h3>
<p>Actor 是 Ray
框架中的一种状态管理单元，允许用户在分布式系统中创建带有持久状态的计算对象。每个
Actor 由一个独立的 Worker
进程运行，支持并行调用方法并维护自身状态。Actor
可以通过远程调用接口与其他组件交互，实现任务分解和动态扩展，是 Ray
中用于构建有状态应用和分布式服务的重要抽象。</p>
<h3 id="driver">driver</h3>
<p>Driver就是用户程序（例如，用@ray.remote修饰的用户python代码），Driver负责Task的定义和提交，需要运行在Ray的Head或者Node节点上。</p>
<h2 id="编译">编译</h2>
<p>安装Ray有多种方法，包括wheel包，pip，conda，容器镜像等。这些内容可以参考<a
target="_blank" rel="noopener" href="https://docs.ray.io/en/latest/ray-overview/installation.html">社区手册</a>。这里介绍从<a
target="_blank" rel="noopener" href="https://docs.ray.io/en/latest/ray-contribute/development.html#building-ray">源码安装</a>。</p>
<h3 id="使用conda环境">使用Conda环境</h3>
<p>官方推荐conda或者venv两种虚拟环境安装ray，建议选择conda。无虚拟环境将无法编译ray，并且在实测中发现了venv的未知错误。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">conda create -c conda-forge python=3.9 -n myenv</span><br><span class="line">conda activate myenv</span><br></pre></td></tr></table></figure>
<h3 id="安装依赖">安装依赖</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y build-essential curl clang pkg-config psmisc unzip</span><br></pre></td></tr></table></figure>
<p><strong>安装bazel</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ci/env/install-bazel.sh</span><br></pre></td></tr></table></figure>
<p><strong>安装npm</strong></p>
<p>用于dashboard</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$</span><span class="language-bash">(curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh)</span></span><br><span class="line">nvm install 14</span><br><span class="line">nvm use 14</span><br></pre></td></tr></table></figure>
<h3 id="构建">构建</h3>
<p><strong>构建dashboard</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ray/python/ray/dashboard/client</span><br><span class="line">npm ci</span><br><span class="line">npm run build</span><br></pre></td></tr></table></figure>
<p><strong>构建ray</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd ../../..</span><br><span class="line">pip install -r requirements.txt</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#如果构建机器的内存小于32G，需要限制内存使用，避免oom</span></span></span><br><span class="line">export BAZEL_ARGS=&quot;--local_ram_resources=8&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#debug编译，保留符号表供调试</span></span></span><br><span class="line">export RAY_DEBUG_BUILD=debug</span><br><span class="line">pip install -e . --verbose</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：有可能构建环境会错误的选择到gcc和lld，会导致一些奇怪的编译错误（例如，你的环境变量中存在lld，被识别，但是构建过程中并不会使用非系统路径下的lld等）。这时可以通过指定LD来解决：</p>
<p>BAZEL_ARGS="--action_env=LD=/usr/bin/ld"</p>
</blockquote>
<h3 id="可选的编译环境变量">可选的编译环境变量</h3>
<ul>
<li><code>RAY_INSTALL_JAVA</code>: If set and equal to <code>1</code>,
extra build steps will be executed to build java portions of the
codebase</li>
<li><code>RAY_INSTALL_CPP</code>: If set and equal to <code>1</code>,
<code>ray-cpp</code> will be installed</li>
<li><code>RAY_DISABLE_EXTRA_CPP</code>: If set and equal to
<code>1</code>, a regular (non - <code>cpp</code>) build will not
provide some <code>cpp</code> interfaces</li>
<li><code>SKIP_BAZEL_BUILD</code>: If set and equal to <code>1</code>,
no Bazel build steps will be executed</li>
<li><code>SKIP_THIRDPARTY_INSTALL</code>: If set will skip installation
of third-party python packages</li>
<li><code>RAY_DEBUG_BUILD</code>: Can be set to <code>debug</code>,
<code>asan</code>, or <code>tsan</code>. Any other value will be
ignored</li>
<li><code>BAZEL_ARGS</code>: If set, pass a space-separated set of
arguments to Bazel. This can be useful for restricting resource usage
during builds, for example. See https://bazel.build/docs/user-manual for
more information about valid arguments.</li>
<li><code>IS_AUTOMATED_BUILD</code>: Used in CI to tweak the build for
the CI machines</li>
<li><code>SRC_DIR</code>: Can be set to the root of the source checkout,
defaults to <code>None</code> which is <code>cwd()</code></li>
<li><code>BAZEL_SH</code>: used on Windows to find a
<code>bash.exe</code>, see below</li>
<li><code>BAZEL_PATH</code>: used on Windows to find
<code>bazel.exe</code>, see below</li>
<li><code>MINGW_DIR</code>: used on Windows to find
<code>bazel.exe</code> if not found in <code>BAZEL_PATH</code></li>
</ul>
<h2 id="启动一个ray集群">启动一个Ray集群</h2>
<p>接下来使用一个简单的例子来使用Ray，这是一个使用概率计算圆周率π的程序（蒙特卡洛法）。蒙特卡洛方法在计算圆周率时设一个正方形内部相切一个圆，这时圆和正方形的面积之比是π/4。在这个正方形内部，随机产生n个点（这些点服从均匀分布），计算它们与中心点的距离是否大于圆的半径，以此判断是否落在圆的内部。统计圆内的点数，与n的比值乘以4，就是π的值。理论上，n越大，计算的π值越精确。</p>
<figure>
<img
src="https://raw.githubusercontent.com/hipudding/blog_img/main/img/3d5d171ad6df43c2babfe981a2ee91e8.jpeg"
alt="蒙特卡洛法" />
<figcaption aria-hidden="true">蒙特卡洛法</figcaption>
</figure>
<figure>
<img
src="https://raw.githubusercontent.com/hipudding/blog_img/main/img/4f050b95b2c1439baa33a66de817e659.jpeg"
alt="蒙特卡洛法" />
<figcaption aria-hidden="true">蒙特卡洛法</figcaption>
</figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ray</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化 Ray</span></span><br><span class="line">ray.init()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 单个任务：生成点并统计圆内点数</span></span><br><span class="line"><span class="meta">@ray.remote</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">count_points_in_circle</span>(<span class="params">num_samples: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_samples):</span><br><span class="line">        x, y = random.uniform(<span class="number">0</span>, <span class="number">1</span>), random.uniform(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> x**<span class="number">2</span> + y**<span class="number">2</span> &lt;= <span class="number">1</span>:</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> count</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_pi</span>(<span class="params">num_samples: <span class="built_in">int</span>, num_workers: <span class="built_in">int</span></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">    <span class="comment"># 每个 worker 分配的样本数</span></span><br><span class="line">    samples_per_worker = num_samples // num_workers</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建并运行任务</span></span><br><span class="line">    futures = [</span><br><span class="line">        count_points_in_circle.remote(samples_per_worker) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_workers)</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 收集结果</span></span><br><span class="line">    total_in_circle = <span class="built_in">sum</span>(ray.get(futures))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 计算圆周率</span></span><br><span class="line">    pi_estimate = <span class="number">4</span> * total_in_circle / num_samples</span><br><span class="line">    <span class="keyword">return</span> pi_estimate</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 总样本数和并行任务数</span></span><br><span class="line">    total_samples = <span class="number">100_000_000</span></span><br><span class="line">    num_workers = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 计算 π</span></span><br><span class="line">    pi = calculate_pi(total_samples, num_workers)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Estimated π: <span class="subst">&#123;pi&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 关闭 Ray</span></span><br><span class="line">    ray.shutdown()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="临时启动">临时启动</h3>
<p>如果不启动Ray集群，直接执行该Python程序，那会在当前节点上默认拉起一个ray集群供计算。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">python pi.py</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#2025-01-21 09:35:24,180 INFO worker.py:1832 -- Started a local Ray instance. View the dashboard at 127.0.0.1:8265</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#Estimated π: 3.12</span></span></span><br></pre></td></tr></table></figure>
<h3 id="启动集群">启动集群</h3>
<p><strong>启动Head节点</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">ray start --head</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#Local node IP: 192.168.64.8</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#--------------------</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#Ray runtime started.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#--------------------</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#Next steps</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#  To add another node to this Ray cluster, run</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#    ray start --address=&#x27;192.168.64.8:6379&#x27;</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#  To connect to this Ray cluster:</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#    import ray</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#    ray.init()</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#  To submit a Ray job using the Ray Jobs CLI:</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#    RAY_ADDRESS=&#x27;http://127.0.0.1:8265&#x27; ray job submit --working-dir . -- python my_script.py</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#  See https://docs.ray.io/en/latest/cluster/running-applications/job-submission/index.html</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#  for more information on submitting Ray jobs to the Ray cluster.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#  To terminate the Ray runtime, run</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#    ray stop</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#  To view the status of the cluster, use</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#    ray status</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#  To monitor and debug Ray, view the dashboard at</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#    127.0.0.1:8265</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#  If connection to the dashboard fails, check your firewall settings and network configuration.</span></span></span><br></pre></td></tr></table></figure>
<p>可以在<code>http://127.0.0.1:8265</code>查看Ray控制台。</p>
<p><strong>启动Node节点</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ray start --address=&#x27;192.168.64.8:6379&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#Local node IP: 192.168.64.9</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#[2025-01-21 10:49:34,903 W 1882 1882] global_state_accessor.cc:463: Retrying to get node with node ID ba8aafea9f23f6f29ff6cd174e31aaac37cddb0e832c4e3170ddcf63</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#--------------------</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#Ray runtime started.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#--------------------</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#To terminate the Ray runtime, run</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#  ray stop</span></span></span><br></pre></td></tr></table></figure>
<p><strong>集群状态</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">======== Autoscaler status: 2025-01-21 10:54:25.170247 ========</span><br><span class="line">Node status</span><br><span class="line">---------------------------------------------------------------</span><br><span class="line">Active:</span><br><span class="line"> 1 node_948847515a43d4fba13c1bdb6a5e5611c2580ecb60f60183ef033771</span><br><span class="line"> 1 node_ba8aafea9f23f6f29ff6cd174e31aaac37cddb0e832c4e3170ddcf63</span><br><span class="line">Pending:</span><br><span class="line"> (no pending nodes)</span><br><span class="line">Recent failures:</span><br><span class="line"> (no failures)</span><br><span class="line"></span><br><span class="line">Resources</span><br><span class="line">---------------------------------------------------------------</span><br><span class="line">Usage:</span><br><span class="line"> 0.0/16.0 CPU</span><br><span class="line"> 0B/8.40GiB memory</span><br><span class="line"> 0B/3.93GiB object_store_memory</span><br><span class="line"></span><br><span class="line">Demands:</span><br><span class="line"> (no resource demands)</span><br></pre></td></tr></table></figure>
<h3 id="启用监控">启用监控</h3>
<p><strong>Prometheus</strong></p>
<p>ray提供了一个命令来下载和部署普罗米修斯，ray提供了数据采集接口，可以让普罗米修斯通过这个接口来收集集群数据，注意，简易命令拉起的普罗米修斯不能用于生产环境，完整部署可参考<a
target="_blank" rel="noopener" href="https://docs.ray.io/en/latest/cluster/metrics.html#optional-manual-running-prometheus-locally">官方手册</a>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ray metrics launch-prometheus</span><br></pre></td></tr></table></figure>
<p>可以在这个地址上查看普罗米修斯状态：http://localhost:9090，可查看其采集的信息<code>ray_dashboard_api_requests_count_requests_total</code>。</p>
<figure>
<img
src="https://raw.githubusercontent.com/hipudding/blog_img/main/img/image-20250121190550385.png"
alt="普罗米修斯dashboard" />
<figcaption aria-hidden="true">普罗米修斯dashboard</figcaption>
</figure>
<p><strong>grafana</strong></p>
<p>普罗米修斯采集的数据，通过grafana的方式进行可视化显示，并且ray
dashboard中的metric页面的信息也是来自于grafana。可以通过启动新的grafana服务来完成配置。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/share/grafana</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#启动grafana需要创建data目录，需要sudo执行</span></span></span><br><span class="line">sudo ./bin/grafana-server --config /tmp/ray/session_latest/metrics/grafana/grafana.ini web</span><br></pre></td></tr></table></figure>
<p>将grafana dashboard加入到已有的grafana server可以参考<a
target="_blank" rel="noopener" href="https://docs.ray.io/en/latest/cluster/metrics.html#simplest-setting-up-grafana-with-ray-provided-configurations">官方手册</a>。</p>
<p>可以在这个地址上查看grafana的dashboard：http://localhost:3000</p>
<figure>
<img
src="https://raw.githubusercontent.com/hipudding/blog_img/main/img/image-20250121191218231.png"
alt="grafana dashboard" />
<figcaption aria-hidden="true">grafana dashboard</figcaption>
</figure>
<p><strong>Ray dashboard</strong></p>
<p>完成上述两个步骤后，Ray
dashboard中的metric即可正常显示，如果不是本机部署，你可能需要配置允许所有ip访问：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RAY_GRAFANA_HOST=http://192.168.64.8:3000 ray start --head --dashboard-host=0.0.0.0</span><br></pre></td></tr></table></figure>
<p><code>RAY_GRAFANA_HOST</code>的作用是让ray的dashboard能够访问到grafana服务；</p>
<p><code>--dashboard-host=0.0.0.0</code>允许所有ip访问。</p>
<figure>
<img
src="https://raw.githubusercontent.com/hipudding/blog_img/main/img/image-20250121191317452.png"
alt="Ray dashboard" />
<figcaption aria-hidden="true">Ray dashboard</figcaption>
</figure>
<figure>
<img
src="https://raw.githubusercontent.com/hipudding/blog_img/main/img/image-20250121191504505.png"
alt="Ray dashboard" />
<figcaption aria-hidden="true">Ray dashboard</figcaption>
</figure>
<h3 id="提交一个任务">提交一个任务</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python pi.py</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#2025-01-21 11:17:11,760 INFO worker.py:1654 -- Connecting to existing Ray cluster at address: 192.168.64.8:6379...</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#2025-01-21 11:17:11,775 INFO worker.py:1832 -- Connected to Ray cluster. View the dashboard at 192.168.64.8:8265</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#Estimated π: 3.36</span></span></span><br></pre></td></tr></table></figure>
<figure>
<img
src="https://raw.githubusercontent.com/hipudding/blog_img/main/img/image-20250121191829305.png"
alt="Ray 任务列表" />
<figcaption aria-hidden="true">Ray 任务列表</figcaption>
</figure>
<figure>
<img
src="https://raw.githubusercontent.com/hipudding/blog_img/main/img/image-20250121191902742.png"
alt="Ray 任务详情" />
<figcaption aria-hidden="true">Ray 任务详情</figcaption>
</figure>
<figure>
<img
src="https://raw.githubusercontent.com/hipudding/blog_img/main/img/image-20250121191917649.png"
alt="Ray 任务详情" />
<figcaption aria-hidden="true">Ray 任务详情</figcaption>
</figure>
<h3 id="部署一个服务">部署一个服务</h3>
<p>Ray除了提供基础的分布式计算能力之外，还提供了一系列的AI
libs，其中可以在其上部署服务，Ray自动提供proxy和负载均衡能力。这里使用一个翻译的服务举例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> starlette.requests <span class="keyword">import</span> Request</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ray</span><br><span class="line"><span class="keyword">from</span> ray <span class="keyword">import</span> serve</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> pipeline</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@serve.deployment(<span class="params">num_replicas=<span class="number">2</span>, ray_actor_options=&#123;<span class="string">&quot;num_cpus&quot;</span>: <span class="number">0.2</span>, <span class="string">&quot;num_gpus&quot;</span>: <span class="number">0</span>&#125;</span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Translator</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Load model</span></span><br><span class="line">        self.model = pipeline(<span class="string">&quot;translation_en_to_fr&quot;</span>, model=<span class="string">&quot;t5-small&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">translate</span>(<span class="params">self, text: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="comment"># Run inference</span></span><br><span class="line">        model_output = self.model(text)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Post-process output to return only the translation text</span></span><br><span class="line">        translation = model_output[<span class="number">0</span>][<span class="string">&quot;translation_text&quot;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> translation</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, http_request: Request</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        english_text: <span class="built_in">str</span> = <span class="keyword">await</span> http_request.json()</span><br><span class="line">        <span class="keyword">return</span> self.translate(english_text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">translator_app = Translator.bind()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    ray.init()</span><br><span class="line">    serve.start(http_options=&#123;<span class="string">&quot;host&quot;</span>: <span class="string">&quot;0.0.0.0&quot;</span>&#125;)  <span class="comment"># 设置监听地址为 0.0.0.0</span></span><br><span class="line">    serve.run(translator_app)</span><br></pre></td></tr></table></figure>
<p>具体修改方法，可以参考<a
target="_blank" rel="noopener" href="https://docs.ray.io/en/latest/serve/getting_started.html">官方手册</a></p>
<p>直接运行这个python程序即可完成服务的部署：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">python translate.py</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#2025-01-21 11:23:45,794 INFO worker.py:1654 -- Connecting to existing Ray cluster at address: 192.168.64.8:6379...</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#2025-01-21 11:23:45,810 INFO worker.py:1832 -- Connected to Ray cluster. View the dashboard at 192.168.64.8:8265</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#INFO 2025-01-21 11:23:46,673 serve 8302 -- Started Serve in namespace &quot;serve&quot;.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#INFO 2025-01-21 11:23:46,675 serve 8302 -- Connecting to existing Serve app in namespace &quot;serve&quot;. New http options will not be applied.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#WARNING 2025-01-21 11:23:46,675 serve 8302 -- The new client HTTP config differs from the existing one in the following fields: [&#x27;host&#x27;, &#x27;location&#x27;]. The new HTTP config is ignored.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#(ServeController pid=6931) INFO 2025-01-21 11:23:46,687 controller 6931 -- Deploying new version of Deployment(name=&#x27;Translator&#x27;, app=&#x27;default&#x27;) (initial target replicas: 2).</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#(ProxyActor pid=8045) INFO 2025-01-21 11:23:46,644 proxy 192.168.64.8 -- Proxy starting on node 8e8707766c1fc9b7d838c24446c99440be5881c04ea44b6e4e83a7aa (HTTP port: 8000).</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#(ProxyActor pid=8045) INFO 2025-01-21 11:23:46,660 proxy 192.168.64.8 -- Got updated endpoints: &#123;&#125;.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#(ProxyActor pid=8045) INFO 2025-01-21 11:23:46,690 proxy 192.168.64.8 -- Got updated endpoints: &#123;Deployment(name=&#x27;Translator&#x27;, app=&#x27;default&#x27;): EndpointInfo(route=&#x27;/&#x27;, app_is_cross_language=False)&#125;.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#(ServeController pid=6931) INFO 2025-01-21 11:23:46,792 controller 6931 -- Adding 2 replicas to Deployment(name=&#x27;Translator&#x27;, app=&#x27;default&#x27;).</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#(ServeReplica:default:Translator pid=8044) Device set to use cpu</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#INFO 2025-01-21 11:23:50,711 serve 8302 -- Application &#x27;default&#x27; is ready at http://0.0.0.0:8000/.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#INFO 2025-01-21 11:23:50,711 serve 8302 -- Deployed app &#x27;default&#x27; successfully.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#(ServeReplica:default:Translator pid=2371, ip=192.168.64.9) Device set to use cpu</span></span></span><br></pre></td></tr></table></figure>
<p>在dashboard上可以看到服务的详情：</p>
<figure>
<img
src="https://raw.githubusercontent.com/hipudding/blog_img/main/img/image-20250121192836367.png"
alt="Ray Serve详情" />
<figcaption aria-hidden="true">Ray Serve详情</figcaption>
</figure>
<figure>
<img
src="https://raw.githubusercontent.com/hipudding/blog_img/main/img/image-20250121192851056.png"
alt="Ray Serve metrics" />
<figcaption aria-hidden="true">Ray Serve metrics</figcaption>
</figure>
<p>通过curl命令可以验证服务运行情况：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST http://127.0.0.1:8000/ -H &quot;Content-Type: application/json&quot; -d &#x27;&quot;Hello world!&quot;&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#Bonjour monde!</span></span></span><br></pre></td></tr></table></figure>
<h2 id="调试">调试</h2>
<p>Ray是一个多进程，Python和C++混合调用的程序（以Python语言为例），调试上需要掌握一定的技巧。调试Python，Driver，以及自动拉起的gcs_server，raylet以及worker，actor的方法都不同。下面以VsCode为例。</p>
<h3 id="调试python">调试python</h3>
<p>Python调试与普通程序调试相同，直接点debug
python文件，或者配置launch.json即可。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Python: pi.py&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;debugpy&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;/pi.py&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;console&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integratedTerminal&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;justMyCode&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="调试driver">调试Driver</h3>
<p>Driver就是用户python程序，调试Driver的Python部分参考上一节，如果调试Driver的C++部分，需要调试python进程，前提是Ray是debug编译的，否则没有符号表无法调试。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Ray C++&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cppdbg&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/hua/miniconda3/envs/myenv/bin/python3.9&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;$&#123;workspaceFolder&#125;/pi.py&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;stopAtEntry&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;environment&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;externalConsole&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;MIMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gdb&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;setupCommands&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;为 gdb 启用整齐打印&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;-enable-pretty-printing&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ignoreFailures&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;将反汇编风格设置为 Intel&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;-gdb-set disassembly-flavor intel&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ignoreFailures&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="调试worker或者其他进程">调试Worker或者其他进程</h3>
<p>gcs_server，raylet，worker以及actor都是自动拉起的进程，调试的时候需要attach到这些进程上进行调试。</p>
<blockquote>
<p>注意，需要接触gdb attach的限制，永久接触方法如下：</p>
<p>sudo vi /etc/sysctl.d/10-ptrace.conf</p>
<p>kernel.yama.ptrace_scope = 0</p>
<p>sudo sysctl --system</p>
</blockquote>
<p>调试上述pi.py，在一个worker的情况下大概需要8G内存，否则会导致Ray
kill掉worker或者gdb异常退出。在调试worker过程中，为了方便，可以限制仅启动一个worker，在本地拉起的情况下，配置<code>ray.init(num_cpus=1)</code>。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Attach to worker&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cppdbg&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;attach&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;processId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;command:pickProcess&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/hua/miniconda3/envs/myenv/bin/python3.9&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;sourceFileMap&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;/proc/self/cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/hua/code/ray&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;setupCommands&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;为 gdb 启用整齐打印&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;-enable-pretty-printing&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ignoreFailures&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;将反汇编风格设置为 Intel&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;-gdb-set disassembly-flavor intel&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ignoreFailures&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>worker和actor是python进程，gcs_server和reylet是非python进程，二进制在
ray/python/ray/core/src/ray/下。</p>
<h2 id="grpc流程">gRPC流程</h2>
<h3 id="grpc是什么">gRPC是什么</h3>
<p>简单来说，RPC框架就是像调用本地函数一样调用远程函数。gRPC使用protobuf来定义服务和传输的对象，在客户端中，有一个存根（Stub），与服务有相同的函数签名，通过调用这个存根，即可完成一次RPC调用。</p>
<figure>
<img
src="https://raw.githubusercontent.com/hipudding/blog_img/main/img/landing-2.svg"
alt="gRPC原理" />
<figcaption aria-hidden="true">gRPC原理</figcaption>
</figure>
<p>Ray是基于gRPC构建的分布式计算系统，有关gRPC的代码存放在
ray/src/ray/rpc目录下，下面，我们通过worker进程的gRPC服务来分析。</p>
<h3 id="grpc-client">gRPC client</h3>
<p>涉及到gRPC client的几个文件：<code>grpc_client.h</code>,
<code>client_call.h</code></p>
<figure>
<img
src="https://raw.githubusercontent.com/hipudding/blog_img/main/img/20250122145957615.png"
alt="gRPC client类图" />
<figcaption aria-hidden="true">gRPC client类图</figcaption>
</figure>
<p><code>ClientCall</code>是对RPC调用的一个封装，主要包括需要调用的stub函数指针，以及相关的状态和结果获取，当gRPC调用返回时，需要回调<code>ClientCall</code>中注册的回调函数。<code>ClientCallManager</code>是对gRPC调用发起的管理，包括结果队列，监听线程等，
<code>GrpcClient</code>保存的是gRPC的连接句柄，可以通过该对象发起一个gRPC请求。</p>
<p>对于CoreWorker来说，在此之上还有一层封装（<code>worker/core_worker_client.h</code>,
<code>worker/core_worker_client_pool.h/cc</code>），<code>CoreWorkerClient</code>，该类封装了CoreWorkerService可用的所用调用，直接调用提供的函数接口即可完成RPC调用。与之匹配的还有一个<code>CoreWorkerClientPool</code>，用于<code>CoreWorkerClient</code>的缓存。</p>
<figure>
<img
src="https://raw.githubusercontent.com/hipudding/blog_img/main/img/image-20250122142401278.png"
alt="CoreWorkerClient 类图" />
<figcaption aria-hidden="true">CoreWorkerClient 类图</figcaption>
</figure>
<p><code>CoreWorkerClientPool</code>维护一个map&lt;WorkerId,
CoreWorkerClient&gt;，当已经存在对应的<code>CoreWorkerClient</code>时直接取出使用。如果不存在，则调用<code>CoreWorkerClientFactoryFn</code>工厂方法创建一个gRPC的client连接。该工厂方法在<code>CoreWorker</code>的构造函数中定义，通过一个<code>rpc::Address</code>创建对应的<code>CoreWorkerClient</code>对象。</p>
<p>每个<code>CoreWorkerClient</code>对象构造过程中，会创建gRPC连接，并且通过<code>ClientCallManager</code>来发起RPC请求，并通过监听CompletionQueue来响应RPC的处理结果。</p>
<h3 id="grpc-server">gRPC server</h3>
<p>涉及到gRPC server的几个文件：<code>grpc_server.h/cc</code>,
<code>client_server.h/cc</code></p>
<figure>
<img
src="https://raw.githubusercontent.com/hipudding/blog_img/main/img/20250122145823773.png"
alt="gPRC Server类图" />
<figcaption aria-hidden="true">gPRC Server类图</figcaption>
</figure>
<p><code>GrpcServer</code>是gRPC的服务端，其中定义了初始化，关闭，注册服务，运行等操作。它会根据其中注册的Service来向gRPC服务中注册服务和对应的处理方法。<code>GrpcService</code>是一个虚拟类，其本身没有实现，需要不同的组件来继承实现，例如，CoreWorker就会用<code>CoreWorkerGrpcService</code>来实现一个Worker对应的Service。Service中需要提供一组<code>ServiceCallFactory</code>，这些Factory记录了服务，gRPC的stub，回调函数，本地异步IO组件等信息，供<code>GrpcServer</code>来注册对应的服务。<code>ServiceCall</code>即服务端服务的本身，包括一系列回调函数处理对应的事件，这个call对象会以Tag的方式放入gRPC请求中，处理时取出call对象对相应的处理。</p>
<p>对于CoreWorker来说，需要基于<code>GrpcService</code>实现<code>GrpcCoreWorkerGrpcService</code>（<code>work/core_worker_server.h</code>）。实际上的工作就是将CoreWorkerService中的服务全部注册到ServiceCallFactory中。</p>
<figure>
<img
src="https://raw.githubusercontent.com/hipudding/blog_img/main/img/image-20250122152145818.png"
alt="CoreWorkerService 类图" />
<figcaption aria-hidden="true">CoreWorkerService 类图</figcaption>
</figure>
<p><code>CoreWorkerServiceHandler</code>是一组Handle方法的集合，包含CoreWorkerService中的所有服务的处理方法，<code>CoreWorkerGrpcService</code>中会通过一组宏来构造protobuf中的注册，响应等必要信息的对象集合（ServiceCallFactory）。</p>
<p>注册完成后，<code>GrpcServer</code>在运行之前，会将所有的事件和响应注册到队列中，这样，队列中进入事件时，就可以调用对应的处理函数进行处理。</p>
<h3 id="本地异步调用">本地异步调用</h3>
<p>Ray使用了大量的异步处理，例如gRPC框架中的请求和响应，以及本地的异步处理框架。Ray的Worker等进程中，除了gRPC的异步框架之外，还有一个<code>boost::asio::io_context</code>框架，所有gRPC的响应并不是在pull_threads中处理，而是把事件转交给本地的异步处理框架，然后在该异步处理框架中处理。并且该框架中还内置了一个EventTracker，来记录所有时间的处理信息。</p>
<p>结果的处理交给本地异步处理来运行，猜测是为了加快gRPC队列中的数据消费。</p>
<h2 id="driver提交流程">Driver提交流程</h2>
<p>以无状态任务为例，描述任务的提交流程。</p>
<h3 id="python部分">Python部分</h3>
<p><strong><span class="citation"
data-cites="ray.remote">@ray.remote</span></strong></p>
<p>被<code>@ray.remote</code>装饰的函数会被ray分布式处理。该装饰器会将函数（或者对象，后续的描述均为函数的装饰）封装成<code>RemoteFunction</code>对象。该对象保存了被装饰函数的function对象，并且提供<code>remote</code>方法。</p>
<p>当<code>remote</code>方法被调用时，会将python函数包装成<code>PythonFunctionDescriptor</code>,记录了module/function/class
name，以及分配的uuid。随后使用pickle_dump将函数序列化，交给worker处理。worker会将序列化后的函数存储到gcs服务的function
table中，并记录该函数的uuid，以便于通过函数描述找到函数体。</p>
<p>以上工作完成后，remote方法会调用worker的submit_task方法提交任务，该任务即可通过gRPC发送到集群中处理。submit_task返回一个object_ref。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">invocation (/home/hua/code/ray/python/ray/remote_function.py:485)</span><br><span class="line">_remote (/home/hua/code/ray/python/ray/remote_function.py:504)</span><br><span class="line">_invocation_remote_span (/home/hua/code/ray/python/ray/util/tracing/tracing_helper.py:310)</span><br><span class="line">auto_init_wrapper (/home/hua/code/ray/python/ray/_private/auto_init_hook.py:21)</span><br><span class="line">_remote_proxy (/home/hua/code/ray/python/ray/remote_function.py:156)</span><br><span class="line">&lt;listcomp&gt; (/home/hua/code/ray/pi.py:23)</span><br><span class="line">calculate_pi (/home/hua/code/ray/pi.py:22)</span><br><span class="line">&lt;module&gt; (/home/hua/code/ray/pi.py:39)</span><br></pre></td></tr></table></figure>
<h3 id="driver部分">Driver部分</h3>
<p><strong>任务提交到本地</strong></p>
<p>Driver的python代码调用submit_task后，会通过cython调用到C++
extention中。对应的函数是<code>CoreWorker::SubmitTask</code>，这里会将相关的任务信息打包成<code>TaskSpec</code>，然后提交到本地异步IO中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_raylet.so!ray::core::CoreWorker::SubmitTask() (/home/hua/code/ray/src/ray/core_worker/core_worker.cc:2467)</span><br><span class="line"></span><br><span class="line">cython ...</span><br><span class="line">Python ...</span><br></pre></td></tr></table></figure>
<p><strong>解决依赖</strong></p>
<p>从异步IO调度到该任务后(<code>NormalTaskSubmitter::SubmitTask</code>)，会先等待依赖的资源处理结束，这里使用了回调的方式异步等待依赖的任务结束。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">_raylet.so!ray::core::NormalTaskSubmitter::SubmitTask() (/home/hua/code/ray/src/ray/core_worker/transport/normal_task_submitter.cc:23)</span><br><span class="line"></span><br><span class="line">_raylet.so!operator()(const struct &#123;...&#125; * const __closure) (/home/hua/code/ray/src/ray/core_worker/core_worker.cc:2469)</span><br><span class="line"></span><br><span class="line">_raylet.so!EventTracker::RecordExecution() (/home/hua/code/ray/src/ray/common/event_stats.cc:113)</span><br><span class="line"></span><br><span class="line">_raylet.so!std::_Function_handler&lt;void(), instrumented_io_context::post() (/home/hua/code/ray/src/ray/common/asio/instrumented_io_context.cc:97)</span><br><span class="line"></span><br><span class="line">从异步IO调度</span><br></pre></td></tr></table></figure>
<p><strong>请求资源</strong></p>
<p>依赖的任务执行结束后，准备执行当前任务，但是对当前SchedulingKey来说目前没有空闲的Worker，需要先向reylet请求Worker，<code>NormalTaskSubmitter::RequestNewWorkerIfNeeded</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">_raylet.so!ray::core::NormalTaskSubmitter::RequestNewWorkerIfNeeded() (/home/hua/code/ray/src/ray/core_worker/transport/normal_task_submitter.cc:347)</span><br><span class="line"></span><br><span class="line">_raylet.so!operator()(struct &#123;...&#125; * const __closure, ray::Status status) (/home/hua/code/ray/src/ray/core_worker/transport/normal_task_submitter.cc:80)</span><br><span class="line"></span><br><span class="line">_raylet.so!ray::core::LocalDependencyResolver::ResolveDependencies() (/home/hua/code/ray/src/ray/core_worker/transport/dependency_resolver.cc:84)</span><br><span class="line"></span><br><span class="line">异步回调</span><br></pre></td></tr></table></figure>
<p><strong>任务提交到集群</strong></p>
<p>Worker资源异步请求会返回空闲Worker的Address，然后可以通过RPC将任务直接提交(<code>PushTask</code>)给这个Worker。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">_raylet.so!ray::rpc::CoreWorkerClient::PushNormalTask() (/home/hua/code/ray/src/ray/rpc/worker/core_worker_client.h:399)</span><br><span class="line"></span><br><span class="line">_raylet.so!ray::core::NormalTaskSubmitter::PushNormalTask() (/home/hua/code/ray/src/ray/core_worker/transport/normal_task_submitter.cc:561)</span><br><span class="line"></span><br><span class="line">_raylet.so!ray::core::NormalTaskSubmitter::OnWorkerIdle() (/home/hua/code/ray/src/ray/core_worker/transport/normal_task_submitter.cc:181)</span><br><span class="line"></span><br><span class="line">_raylet.so!operator()() (/home/hua/code/ray/src/ray/core_worker/transport/normal_task_submitter.cc:436)</span><br><span class="line"></span><br><span class="line">RPC回调</span><br></pre></td></tr></table></figure>
<h2 id="worker执行流程">Worker执行流程</h2>
<p><strong>调试技巧</strong></p>
<ol type="1">
<li>首先启动Driver，在<code>INVOKE_RPC_CALL</code>执行之前打断点，阻塞任务提交到集群。</li>
<li>attach到Worker进程上，并且在<code>CoreWorker::HandlePushTask</code>打断点，这里是处理RPC请求的入口。</li>
<li>让Driver继续执行，Worker就会命中断点，可以继续调试Worker。</li>
</ol>
<p><strong>gRPC将任务提交到本地</strong></p>
<p><code>GrpcServer::PollEventsFromCompletionQueue</code>会等待gRPC请求，当收到请求后，就会调用从Tag中取出ServerCall对象，该对象中保存着该请求的所有处理的必要信息。然后将该任务提交给异步IO。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">_raylet.so!ray::rpc::ServerCallImpl&lt;ray::rpc::CoreWorkerServiceHandler, ray::rpc::GetCoreWorkerStatsRequest, ray::rpc::GetCoreWorkerStatsReply, (ray::rpc::AuthType)0&gt;::HandleRequest() (/home/hua/code/ray/bazel-out/aarch64-dbg/bin/_virtual_includes/grpc_common_lib/ray/rpc/server_call.h:237)</span><br><span class="line"></span><br><span class="line">_raylet.so!ray::rpc::GrpcServer::PollEventsFromCompletionQueue() (/home/hua/code/ray/src/ray/rpc/grpc_server.cc:199)</span><br><span class="line"></span><br><span class="line">gRPC pulling thread</span><br></pre></td></tr></table></figure>
<p><strong>调用gRPC注册的Handler方法</strong></p>
<p>异步IO会回调注册的方法<code>CoreWorker::HandlePushTask</code>，配置定义<code>send_reply_callback</code>回调函数，最后将任务通过异步IO提交给<code>task_execution_service</code>（就是另外一个异步IO队列）。</p>
<p><strong>执行函数</strong></p>
<p>当执行调度到PushTask任务时，就会回调上一步配置的<code>send_reply_callback</code>回调，远程函数的执行就在这个回调中运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">_raylet.so!operator()(const struct &#123;...&#125; * const __closure, const ray::TaskSpecification &amp; task_spec, ray::rpc::SendReplyCallback send_reply_callback) (/home/hua/code/ray/src/ray/core_worker/transport/task_receiver.cc:100)</span><br><span class="line"></span><br><span class="line">_raylet.so!ray::core::InboundRequest::Accept(ray::core::InboundRequest * const this) (/home/hua/code/ray/src/ray/core_worker/transport/actor_scheduling_util.cc:36)</span><br><span class="line"></span><br><span class="line">_raylet.so!ray::core::NormalSchedulingQueue::ScheduleRequests(ray::core::NormalSchedulingQueue * const this) (/home/hua/code/ray/src/ray/core_worker/transport/normal_scheduling_queue.cc:87)</span><br><span class="line"></span><br><span class="line">_raylet.so!ray::core::TaskReceiver::RunNormalTasksFromQueue(ray::core::TaskReceiver * const this) (/home/hua/code/ray/src/ray/core_worker/transport/task_receiver.cc:294)</span><br><span class="line"></span><br><span class="line">_raylet.so!operator()(const struct &#123;...&#125; * const __closure) (/home/hua/code/ray/src/ray/core_worker/core_worker.cc:3777)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>回调中的<code>task_handler_</code>
就是注册进去的<code>CoreWorker::ExecuteTask</code>，将这个对象封装成了一个lamda函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> execute_task = std::<span class="built_in">bind</span>(&amp;CoreWorker::ExecuteTask,</span><br><span class="line">                                  <span class="keyword">this</span>,</span><br><span class="line">                                  std::placeholders::_1,</span><br><span class="line">                                  std::placeholders::_2,</span><br><span class="line">                                  std::placeholders::_3,</span><br><span class="line">                                  std::placeholders::_4,</span><br><span class="line">                                  std::placeholders::_5,</span><br><span class="line">                                  std::placeholders::_6,</span><br><span class="line">                                  std::placeholders::_7,</span><br><span class="line">                                  std::placeholders::_8);</span><br></pre></td></tr></table></figure>
<p>最终调用到了<code>options_.task_execution_callback</code>，这个callback会根据语言的不同而不同，以Python为例，这个callback调用的是注册进来的一个Python方法，将Python的远程函数交还给Python解释器来执行。这部分代码在ray/python/ray/_raylet.pyx中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cdef void execute_task: return function(actor, *arguments, **kwarguments)</span><br><span class="line">cdef execute_task_with_cancellation_handler: execute_task</span><br><span class="line">cdef CRayStatus task_execution_handler: execute_task_with_cancellation_handler</span><br><span class="line">CoreWorker::__cinit__: options.task_execution_callback = task_execution_handler</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/11/13/OpenCV%E6%98%87%E8%85%BE%E5%8E%9F%E7%94%9F%E6%94%AF%E6%8C%81/" rel="prev" title="OpenCV昇腾原生支持">
                  <i class="fa fa-angle-left"></i> OpenCV昇腾原生支持
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/02/10/Ray-DAG%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/" rel="next" title="Ray DAG 源码解读">
                  Ray DAG 源码解读 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">hipudding</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/hipudding" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  






  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
